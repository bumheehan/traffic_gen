<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .none {
            display: none;
        }

        table {
            width: 100%;
            border-top: 1px solid #444444;
            border-collapse: collapse;
        }

        th,
        td {
            border-bottom: 1px solid #444444;
            padding: 10px;
        }

    </style>
</head>

<body>
    <h1>트래픽 발생기</h1>
    <div>
        <div>
            <label for="host">Host : </label>
            <input type="text" id="host" placeholder="https://192.168.1.1">
        </div>
        <div>
            <select name="method" id="method">
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
                <option value="PATCH">PATCH</option>
                <option value="TRACE">TRACE</option>
                <option value="OPTIONS">OPTIONS</option>
                <option value="HEAD">HEAD</option>
            </select>
        </div>
        <div>
            <select name="mode" id="mode">
                <option value="constant">동일</option>
                <option value="individual">개별</option>
            </select>
        </div>
        <div id="hourlyCntBox">
            <label for="hourlyCnt">Constant Req/Min : </label>
            <input type="text" id="hourlyCnt" placeholder="10">
        </div>
        <div id="hourlyEachCntBox" class="none">
            <label for="hourlyEachCnt">Hourly Req/Min : </label>
            <input type="text" id="hourlyEachCnt" placeholder="1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24">
        </div>
        <div id="errorBox" >
            <label for="error">오차율 : </label>
            <input type="text" id="error" placeholder="5">
        </div>
        <div>
            <input type="button" id="addBtn" value="추가">
        </div>
    </div>


    <div>
        <div>Json Append</div>
        <textarea name="reqJson" id="reqJson" cols="30" rows="10"></textarea>
        <div>
            <input type="button" id="addBulkBtn" value="추가">
            <input type="button" id="getBulkBtn" value="추출">
        </div>
    </div>

    <div>
        <table id="list">
            <thead>
                <tr>
                    <th>Index</th>
                    <th>Host</th>
                    <th>Method</th>
                    <th>Houly Req/Min Count</th>
                    <th>Error Percent</th>
                    <th>total Request</th>
                    <th>2XX</th>
                    <th>3XX</th>
                    <th>4XX</th>
                    <th>5XX</th>
                    <th>fail</th>
                    <th>DELETE</th>
                </tr>
            </thead>
            <tbody>

            </tbody>

        </table>

    </div>

    <script>
        document.getElementById("mode").addEventListener("change", function() {
            var hourlyEachCnt = document.getElementById("hourlyEachCntBox");
            var hourlyCnt = document.getElementById("hourlyCntBox");
            if (mode.value == "constant") {
                hourlyEachCnt.setAttribute("class", "none");
                hourlyCnt.setAttribute("class", "");
            } else {
                hourlyEachCnt.setAttribute("class", "");
                hourlyCnt.setAttribute("class", "none");

            }
        });
        document.getElementById("addBulkBtn").addEventListener("click", function() {
            var json = JSON.parse(document.getElementById("reqJson").value);
            if (!Array.isArray(json)) {
                alert("최상단 array 형식");
                return;
            }
            for (var i = 0; i < json.length; i++) {
                if (!valid(json[i].host, json[i].hourlyCnt)) {
                    alert("valid 에러, host : " + json[i].host + " hourly req/min : " + json[i].hourlyCnt);
                }
            }
            axios.post("/req/list", json).then(function(response) {
                console.log(response);
            });
        });
        document.getElementById("getBulkBtn").addEventListener("click", function() {
            var list = document.getElementById("list").children[1].children;
            var cnt = [];
            for (var i = 0; i < list.length; i++) {
                cnt.push({
                    host: list[i].children[1].innerText,
                    method : list[i].children[2].innerText,
                    errPer : list[i].children[4].innerText,
                    hourlyCnt: JSON.parse("[" + list[i].children[3].innerText + "]")
                })
            }
            const t = document.createElement("textarea");
            document.body.appendChild(t);
            t.value = JSON.stringify(cnt);
            t.select();
            document.execCommand('copy');
            document.body.removeChild(t);
            alert("복사 완료");
        });

        var urlRex = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)./;
        document.getElementById("addBtn").addEventListener("click", function() {
            var host = document.getElementById("host").value;
            var mode = document.getElementById("mode").value;
            var method = document.getElementById("method").value;
            var error = document.getElementById("error").value;
            if(error==undefined||error==""){
                error = 0;
            }
            var cnt = [];
            if (mode == "constant") {
                var hourlyCnt = document.getElementById("hourlyCnt");
                for (var i = 0; i < 24; i++) {
                    cnt.push(Number.parseInt(hourlyCnt.value));
                }
            } else {
                var hourlyEachCnt = document.getElementById("hourlyEachCnt");
                cnt = JSON.parse("[" + hourlyEachCnt.value + "]");
            }

            if (valid(host, cnt)) {
                var data = {
                    host: host,
                    method : method,
                    hourlyCnt: cnt,
                    errorPer: error
                }
                axios.post("/req", data).then(function(response) {
                    refresh();
                });

            }

        });

        function valid(host, cnt) {
            if (host == "") {
                alert("Host 입력")
                return false;

            }
            if (!urlRex.test(host)) {
                alert("Host url 포맷 아님")
                return false;

            }

            if (cnt.length != 24) {
                alert("24개의 데이터가 필요합니다.");
                return false;
            }
            for (var i = 0; i < 24; i++) {
                if (!Number.isInteger(cnt[i])) {
                    alert("요청 횟수 입력");
                    return false;
                }
            }

            return true;
        }

        function refresh() {
            axios.get('/result')
                .then(function(response) {
                    console.log(response.data);
                    var list = document.getElementById("list").children[1];
                    list.innerHTML = "";
                    for (var i = 0; i < response.data.length; i++) {
                        var tr = document.createElement("tr");
                        var tdIndex = document.createElement("td");
                        var tdHost = document.createElement("td");
                        var tdMethod = document.createElement("td");
                        var tdCnt = document.createElement("td");
                        var tdTotalReq = document.createElement("td");
                        var tdErrorPerc = document.createElement("td");
                        var td2xx = document.createElement("td");
                        var td3xx = document.createElement("td");
                        var td4xx = document.createElement("td");
                        var td5xx = document.createElement("td");
                        var tdFail = document.createElement("td");
                        var tdDelBtn = document.createElement("td");
                        tdIndex.innerText = response.data[i].index; 
                        tdHost.innerText = response.data[i].host;
                        tdMethod.innerText = response.data[i].method;
                        tdCnt.innerText = response.data[i].hourlyCnt;
                        tdTotalReq.innerText = response.data[i].totalReq;
                        tdErrorPerc.innerText = response.data[i].errPer;
                        td2xx.innerText = response.data[i].x2xx;
                        td3xx.innerText = response.data[i].x3xx;
                        td4xx.innerText = response.data[i].x4xx;
                        td5xx.innerText = response.data[i].x5xx;
                        tdFail.innerText = response.data[i].xfail;
                        tdDelBtn.innerText = "";
                        var delBtn = document.createElement("button");
                        delBtn.innerText = "Delete";
                        delBtn.addEventListener("click", function() {
                            
                            axios.delete("/req/"+this.parentNode.parentNode.children[0].innerText);
                        })
                        tdDelBtn.appendChild(delBtn);
                        tr.appendChild(tdIndex);
                        tr.appendChild(tdHost);
                        tr.appendChild(tdMethod);
                        tr.appendChild(tdCnt);
                        tr.appendChild(tdErrorPerc);
                        tr.appendChild(tdTotalReq);
                        tr.appendChild(td2xx);
                        tr.appendChild(td3xx);
                        tr.appendChild(td4xx);
                        tr.appendChild(td5xx);
                        tr.appendChild(tdFail);
                        tr.appendChild(tdDelBtn);
                        list.appendChild(tr);
                    }
                })
                .catch(function(error) {
                    console.log(error);
                })
        }

        var refeshScheduler = setInterval(function() {
            refresh();
        }, 1000);

    </script>
</body>

</html>
